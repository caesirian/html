<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Financiero - HG Soluciones</title>

<!-- CSS: kept exactly the HG look you provided -->
<link href="https://cdn.jsdelivr.net/npm/datatables.net-dt@1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/datatables.net-buttons-dt@2.4.1/css/buttons.dataTables.min.css" rel="stylesheet"/>
<style>
:root{
  --bg: #0f1724;
  --card: #0b1220;
  --accent: #3ea6ff;
  --accent-2: #7b61ff;
  --muted: #9aa8ba;
  --glass: rgba(255,255,255,0.03);
  --text: #e6eef8;
  --card-contrast: rgba(255,255,255,0.02);
  font-family: Inter, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  --radius: 12px;
}

/* Page */
html,body{
  height:100%;
  margin:0;
  background: linear-gradient(180deg,#071226 0%, #081426 100%);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Sidebar basic (kept from your layout) */
.app{display:flex; min-height:100vh;}
aside.sidebar{width:260px; background:linear-gradient(180deg, rgba(11,18,32,0.9), rgba(6,10,18,0.85)); padding:18px; box-shadow: 0 6px 24px rgba(2,6,12,0.6);}
aside h1{font-size:18px; margin:0 0 12px; letter-spacing:0.6px; color:var(--accent);}
aside .nav{display:flex; flex-direction:column; gap:8px;}
aside .nav button{background:transparent; border:0; color:var(--muted); text-align:left; padding:10px; border-radius:8px; cursor:pointer;}
aside .nav button.active, aside .nav button:hover{background:var(--glass); color:#fff;}

main{flex:1; padding:18px; display:flex; flex-direction:column; gap:12px;}

/* Header */
.header-hg{
  padding:0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:4px;
}
.header-hg h1{
  margin:0;
  font-size:18px;
  color:var(--accent);
  letter-spacing:0.4px;
}
.header-hg p{ margin:0; color:var(--muted); font-size:13px; }

/* Layout grid */
.dashboard-grid{
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 12px;
  padding: 0 0 12px 0;
  align-items: start;
}

/* Cards + panels */
.card, .panel{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 6px 20px rgba(3,7,12,0.6);
  border: 1px solid rgba(255,255,255,0.02);
}

/* Grid placements */
.card[data-grid="span-3"] { grid-column: span 3; min-height:110px; display:flex; flex-direction:column; justify-content:center; }
.card[data-grid="span-4"] { grid-column: span 4; min-height:220px; }
.card[data-grid="span-5"] { grid-column: span 5; min-height:220px; }
.card[data-grid="span-6"] { grid-column: span 6; min-height:220px; }
.card[data-grid="full"] { grid-column: 1 / -1; }

/* KPI grande */
.kpi-grande{
  font-size:28px;
  font-weight:800;
  color:#ffffff;
  margin-top:8px;
  letter-spacing:0.4px;
}

/* Headings inside cards */
.card h2{
  margin:0;
  font-size:14px;
  color:var(--muted);
  font-weight:600;
  margin-bottom:8px;
}

/* Canvas container - FIX para gráficos que no se expandan */
.chart-container {
  position: relative;
  height: 180px;
  width: 100%;
}

.chart-container-medium {
  height: 200px;
}

.chart-container-large {
  height: 260px;
}

/* Table styles */
table.display{
  width:100%;
  border-collapse:collapse;
}
table.display thead th{
  background: transparent;
  color:var(--muted);
  font-weight:600;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  padding:10px 8px;
  text-align:left;
  font-size:13px;
}
table.display tbody td{
  padding:10px 8px;
  color:var(--text);
  border-bottom: 1px dashed rgba(255,255,255,0.02);
  font-size:13px;
}

/* Buttons (reuse style from main layout) */
.btn{
  background:var(--accent);
  color:#00121a;
  border:0;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.btn.small {
  padding: 6px 10px;
  font-size: 12px;
}
.btn.secondary{
  background:transparent;
  color:var(--muted);
  border:1px solid rgba(255,255,255,0.04);
}

/* Footer */
.footer-hg{
  padding:12px 18px;
  color:var(--muted);
  font-size:13px;
  border-top:1px solid rgba(255,255,255,0.02);
  margin-top:18px;
}

/* Responsive */
@media (max-width:1200px){
  .card[data-grid="span-3"] { grid-column: span 4; }
  .card[data-grid="span-5"] { grid-column: span 8; }
  .card[data-grid="span-4"] { grid-column: span 8; }
  .card[data-grid="full"] { grid-column: 1 / -1; }
}
@media (max-width:900px){
  .dashboard-grid{ grid-template-columns: repeat(6, 1fr); padding:12px; }
  .card[data-grid="span-3"],
  .card[data-grid="span-4"],
  .card[data-grid="span-5"],
  .card[data-grid="span-6"] { grid-column: span 6; }
  .card[data-grid="full"] { grid-column: span 6; }
}
@media (max-width:600px){
  .dashboard-grid{ grid-template-columns: repeat(1, 1fr); }
  .card[data-grid="span-3"],
  .card[data-grid="span-4"],
  .card[data-grid="span-5"],
  .card[data-grid="span-6"],
  .card[data-grid="full"] { grid-column: span 1; }
}

/* Small helpers */
.text-muted{ color:var(--muted); font-size:13px; }
.kpi-small{ font-size:13px; color:var(--muted); }

/* DataTables override for dark theme */
.dataTables_wrapper .dataTables_filter input { 
  background: rgba(255,255,255,0.02); 
  border:1px solid rgba(255,255,255,0.04); 
  color:var(--text); 
  padding:6px; 
  border-radius:6px; 
}
.dataTables_wrapper .dataTables_length select { 
  background: rgba(255,255,255,0.02); 
  border:1px solid rgba(255,255,255,0.04); 
  color:var(--text); 
  padding:6px; 
  border-radius:6px; 
}
.dataTables_wrapper .dt-buttons .dt-button { 
  background: transparent; 
  color:var(--muted); 
  border:1px solid rgba(255,255,255,0.03); 
  border-radius:8px; 
  padding:6px 8px; 
  margin-right:6px; 
}

/* subtle hover */
.card:hover{ 
  transform: translateY(-2px); 
  transition: all 220ms ease; 
  box-shadow: 0 8px 24px rgba(2,6,12,0.7); 
}

/* tiny loader */
.loader{ 
  display:inline-block; 
  width:16px; 
  height:16px; 
  border:2px solid rgba(255,255,255,0.06); 
  border-top-color:var(--accent); 
  border-radius:50%; 
  animation:spin 1s linear infinite; 
}
@keyframes spin{ 
  to{ transform:rotate(360deg); } 
}

/* Responsive chart containers */
@media (max-width: 768px) {
  .chart-container {
    height: 160px;
  }
  .chart-container-medium {
    height: 180px;
  }
  .chart-container-large {
    height: 220px;
  }
}

/* Ensure cards don't overflow */
.card {
  overflow: hidden;
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" role="navigation">
    <h1>HG - Dashboard Financiero</h1>
    <div class="nav">
      <button id="nav-overview" class="active">Resumen</button>
      <button id="nav-ventas">Ventas</button>
      <button id="nav-finanzas">Finanzas</button>
      <button id="nav-simulador">Simulador</button>
      <button id="nav-tablas">Tablas</button>
    </div>
    <footer style="margin-top:14px;color:var(--muted);font-size:12px">
      <div>Conexión: <span id="conn-status">sin iniciar</span></div>
      <div style="margin-top:8px"><button class="btn small" id="refresh-data">Actualizar datos</button></div>
    </footer>
  </aside>

  <main>
    <header class="topbar header-hg" style="display:flex; align-items:center; gap:12px;">
      <div>
        <h1 style="margin:0">Dashboard Financiero</h1>
        <p style="margin:0; color:var(--muted); font-size:13px">Conexión en vivo a Google Sheets — estilo HG</p>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <div id="estado" class="text-muted">Esperando datos...</div>
        <button id="btn-export" class="btn small">Exportar CSV</button>
      </div>
    </header>

    <div class="dashboard-grid" style="margin-top:12px;">
      <!-- Los componentes se renderizarán aquí dinámicamente -->
    </div>

    <footer class="footer-hg">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="text-muted">Última sincronización: <span id="last-sync">nunca</span></div>
        <div class="text-muted">Cache: <span id="cache-status">no</span></div>
      </div>
    </footer>
  </main>
</div>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-buttons@2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-buttons@2.4.1/js/buttons.html5.min.js"></script>

<script>
// ====== CONFIGURACIÓN GLOBAL ======
const CONFIG = {
  GAS_ENDPOINT: "https://script.google.com/macros/s/AKfycbyTLrGiqes1VOp8E51Kq91P7YihPKNtN1f0f6u2JitXOteGyGrNXqiSjdXYJ8HAtfs/exec",
  CACHE_KEY: "hg_dashboard_cache_v4",
  CACHE_TTL: 1000 * 60 * 60 // 1 hora
};

// ====== REGISTRO DE COMPONENTES ======
const COMPONENTES = {
  componentesActivos: [
    'saldoCaja',
    'ingresosVsEgresos',
    'egresosVsAnterior', 
    'cuentasPendientes'
  ],
  
  registros: {}
};

// ====== UTILIDADES ======
const UTILS = {
  // Nueva función para formatear fecha
  formatDate(dateString) {
    if (!dateString) return '';
    
    try {
      const date = this.parseDate(dateString);
      if (isNaN(date.getTime())) return dateString;
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      return `${day}/${month}/${year}`;
    } catch (error) {
      console.error('Error formateando fecha:', error);
      return dateString;
    }
  },
  
  parseNumber(val) {
    if(val === null || val === undefined || val === "") return 0;
    if(typeof val === "number") return val;
    const s = String(val).replace(/[^0-9\-,\.]/g,"").trim();
    if(!s) return 0;
    const parts = s.split(',');
    if(parts.length > 1 && parts[0].includes('.')) {
      return parseFloat(s.replace(/\./g,'').replace(',','.')) || 0;
    }
    return parseFloat(s.replace(',', '.')) || 0;
  },

  parseDate(v) {
    if(!v) return new Date(NaN);
    if(v instanceof Date) return v;
    const s = String(v).trim();
    if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
    if(/^\d{2}\/\d{2}\/\d{4}/.test(s)) {
      const [d,m,y] = s.split('/');
      return new Date(Number(y), Number(m)-1, Number(d));
    }
    const n = Number(s);
    if(!isNaN(n) && n > 1000) {
      const epoch = new Date(Date.UTC(1899,11,30));
      epoch.setUTCDate(epoch.getUTCDate() + Math.floor(n));
      return epoch;
    }
    return new Date(s);
  },

  formatCurrency(n) {
    const sign = n < 0 ? '-' : '';
    const abs = Math.abs(Number(n) || 0);
    return sign + '$' + abs.toLocaleString('es-AR', {minimumFractionDigits:0, maximumFractionDigits:0});
  },

  saveCache(obj) {
    localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify({ts: Date.now(), data: obj}));
    document.getElementById('cache-status').innerText = 'sí';
  },

  loadCache() {
    try {
      const raw = localStorage.getItem(CONFIG.CACHE_KEY);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(Date.now() - parsed.ts > CONFIG.CACHE_TTL) return null;
      return parsed.data;
    } catch(e) {
      return null;
    }
  }
};

// ====== GESTOR DE DATOS ======
const DataManager = {
  async fetchData(force = false) {
    if(!force) {
      const cached = UTILS.loadCache();
      if(cached) {
        document.getElementById('conn-status').innerText = 'cache local';
        return cached;
      }
    }

    document.getElementById('conn-status').innerText = 'cargando...';
    try {
      const res = await fetch(CONFIG.GAS_ENDPOINT);
      if(!res.ok) throw new Error('Error al consultar endpoint: ' + res.status);
      const data = await res.json();
      UTILS.saveCache(data);
      document.getElementById('conn-status').innerText = 'conectado';
      document.getElementById('last-sync').innerText = new Date().toLocaleString();
      return data;
    } catch(error) {
      document.getElementById('conn-status').innerText = 'error';
      throw error;
    }
  }
};

// ====== SISTEMA DE COMPONENTES ======
const ComponentSystem = {
  registrar(id, config) {
    COMPONENTES.registros[id] = config;
  },

  async render(data) {
    const grid = document.querySelector('.dashboard-grid');
    grid.innerHTML = '';

    for(const componentId of COMPONENTES.componentesActivos) {
      const component = COMPONENTES.registros[componentId];
      if(component) {
        try {
          await this.renderComponent(componentId, component, data, grid);
        } catch(error) {
          console.error(`Error renderizando componente ${componentId}:`, error);
        }
      }
    }
  },

  async renderComponent(id, component, data, grid) {
    const element = document.createElement(component.element || 'section');
    element.id = `componente-${id}`;
    element.className = component.classes || 'card';
    element.setAttribute('data-grid', component.grid);
    
    if(component.html) {
      element.innerHTML = component.html;
    }

    grid.appendChild(element);

    if(component.render) {
      await component.render(data, element);
    }
  },

  agregarComponente(id) {
    if(!COMPONENTES.componentesActivos.includes(id)) {
      COMPONENTES.componentesActivos.push(id);
    }
  },

  removerComponente(id) {
    const index = COMPONENTES.componentesActivos.indexOf(id);
    if(index > -1) {
      COMPONENTES.componentesActivos.splice(index, 1);
    }
  }
};

// ====== DEFINICIÓN DE COMPONENTES ======

// Componente: Saldo de Caja
ComponentSystem.registrar('saldoCaja', {
  grid: 'span-3',
  html: `
    <h2>Saldo de caja</h2>
    <div id="saldo-actual" class="kpi-grande">Cargando...</div>
    <div id="saldo-fecha" class="text-muted" style="margin-top:6px;">—</div>
  `,
  async render(data, element) {
    const arr = data.Caja_Movimientos || data.caja_movimientos || data['Caja_Movimientos'] || [];
    
    if(!arr || arr.length === 0) {
      element.querySelector('#saldo-actual').innerText = 'Sin datos';
      return;
    }

    const sample = arr.find(r => r && typeof r === 'object');
    const keys = sample ? Object.keys(sample) : [];
    const saldoKey = keys.find(k => /saldo/i.test(k));
    
    if(saldoKey) {
      let lastVal = null;
      let lastRow = null;
      for(let i = arr.length-1; i >= 0; i--) {
        const v = arr[i][saldoKey];
        if(v !== null && v !== undefined && String(v).trim() !== '') {
          lastVal = v;
          lastRow = arr[i];
          break;
        }
      }
      const numeric = UTILS.parseNumber(lastVal);
      element.querySelector('#saldo-actual').innerText = UTILS.formatCurrency(numeric);
      
      const dateKey = keys.find(k => /fecha|date/i.test(k));
      if(lastRow && dateKey && lastRow[dateKey]) {
        const pd = UTILS.parseDate(lastRow[dateKey]);
        if(!isNaN(pd.getTime())) {
          element.querySelector('#saldo-fecha').innerText = 
            'Saldo registrado al ' + (pd.getDate()+"/"+(pd.getMonth()+1)+"/"+pd.getFullYear());
        }
      }
    }
  }
});

// Componente: Ingresos vs Egresos
ComponentSystem.registrar('ingresosVsEgresos', {
  grid: 'span-5',
  html: `
    <h2>Ingresos: mes actual vs mes anterior</h2>
    <div class="chart-container">
      <canvas id="grafico-ingresos"></canvas>
    </div>
  `,
  async render(data, element) {
    const fin = data.Finanzas_RegistroDiario || data['Finanzas_RegistroDiario'] || data.Caja_Movimientos || [];
    const sample = fin.find(r => r && typeof r === 'object') || {};
    const keys = Object.keys(sample);
    const montoKey = keys.find(k => /monto|importe|total/i.test(k)) || null;
    const tipoKey = keys.find(k => /tipo|ingres|egres/i.test(k)) || null;
    const fechaKey = keys.find(k => /fecha|date/i.test(k)) || null;
    
    const sums = {};
    for(const row of fin) {
      const rawFecha = row[fechaKey] ?? row['Fecha'] ?? row['fecha'] ?? row['Date'] ?? null;
      const d = UTILS.parseDate(rawFecha);
      const key = (!isNaN(d.getTime())) ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` : 'sin-fecha';
      if(!sums[key]) sums[key] = {ing:0, eg:0};
      const tipo = String(row[tipoKey] ?? '').toLowerCase();
      const monto = UTILS.parseNumber(row[montoKey] ?? row['Monto'] ?? row['Importe'] ?? row['Total'] ?? 0);
      
      if(tipoKey && tipo.includes('ingre')) sums[key].ing += monto;
      else if(tipoKey && tipo.includes('egre')) sums[key].eg += Math.abs(monto);
      else {
        if(monto >= 0) sums[key].ing += monto;
        else sums[key].eg += Math.abs(monto);
      }
    }

    const today = new Date();
    const curKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    const prev = new Date(today.getFullYear(), today.getMonth()-1, 1);
    const prevKey = `${prev.getFullYear()}-${String(prev.getMonth()+1).padStart(2,'0')}`;

    const ingActual = sums[curKey]?.ing || 0;
    const ingPrev = sums[prevKey]?.ing || 0;

    const canvas = element.querySelector('#grafico-ingresos');
    const ctx = canvas.getContext('2d');
    
    // Destruir gráfico anterior si existe
    if(window.chartIngresos) {
      window.chartIngresos.destroy();
    }
    
    window.chartIngresos = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Mes anterior', 'Mes actual'],
    datasets: [{
      label: 'Ingresos',
      data: [ingPrev, ingActual],
      backgroundColor: function(context) {
        const chart = context.chart;
        const {ctx, chartArea} = chart;
        if (!chartArea) return 'rgba(58,123,213,0.8)';
        
        // Crear gradiente para efecto relieve
        const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
        gradient.addColorStop(0, 'rgba(40,100,200,0.9)');    // Parte inferior oscura
        gradient.addColorStop(0.6, 'rgba(62,166,255,0.9)'); // Parte media
        gradient.addColorStop(1, 'rgba(100,180,255,1)');    // Parte superior clara (efecto luz)
        
        return gradient;
      },
      borderColor: [
        'rgba(40,100,200,1)',
        'rgba(50,140,230,1)'
      ],
      borderWidth: 1,
      // Efecto de profundidad con sombra
      shadowOffsetX: 2,
      shadowOffsetY: 2,
      shadowBlur: 8,
      shadowColor: 'rgba(0,0,0,0.3)'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { display: false },
      tooltip: {
        backgroundColor: 'rgba(0,0,0,0.8)',
        titleColor: '#fff',
        bodyColor: '#fff',
        borderColor: 'rgba(255,255,255,0.1)',
        borderWidth: 1,
        cornerRadius: 4,
        displayColors: false
      }
    },
    scales: {
      y: { 
        ticks: { color: '#cbdff3' }, 
        beginAtZero: true,
        grid: {
          color: 'rgba(255,255,255,0.05)'
        }
      },
      x: { 
        ticks: { color: '#cbdff3' },
        grid: {
          display: false
        }
      }
    },
    // Hacer las barras más angostas
    barPercentage: 0.4,
    categoryPercentage: 0.6
  }
});
  }
});

// Componente: Egresos vs Anterior
ComponentSystem.registrar('egresosVsAnterior', {
  grid: 'span-4',
  html: `
    <h2>Egresos: mes actual vs mes anterior</h2>
    <div class="chart-container">
      <canvas id="grafico-egresos"></canvas>
    </div>
  `,
  async render(data, element) {
    const fin = data.Finanzas_RegistroDiario || data['Finanzas_RegistroDiario'] || data.Caja_Movimientos || [];
    const sample = fin.find(r => r && typeof r === 'object') || {};
    const keys = Object.keys(sample);
    const montoKey = keys.find(k => /monto|importe|total/i.test(k)) || null;
    const tipoKey = keys.find(k => /tipo|ingres|egres/i.test(k)) || null;
    const fechaKey = keys.find(k => /fecha|date/i.test(k)) || null;
    
    const sums = {};
    for(const row of fin) {
      const rawFecha = row[fechaKey] ?? row['Fecha'] ?? row['fecha'] ?? row['Date'] ?? null;
      const d = UTILS.parseDate(rawFecha);
      const key = (!isNaN(d.getTime())) ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` : 'sin-fecha';
      if(!sums[key]) sums[key] = {ing:0, eg:0};
      const tipo = String(row[tipoKey] ?? '').toLowerCase();
      const monto = UTILS.parseNumber(row[montoKey] ?? row['Monto'] ?? row['Importe'] ?? row['Total'] ?? 0);
      
      if(tipoKey && tipo.includes('egre')) sums[key].eg += Math.abs(monto);
      else if(!tipoKey && monto < 0) sums[key].eg += Math.abs(monto);
    }

    const today = new Date();
    const curKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    const prev = new Date(today.getFullYear(), today.getMonth()-1, 1);
    const prevKey = `${prev.getFullYear()}-${String(prev.getMonth()+1).padStart(2,'0')}`;

    const egActual = sums[curKey]?.eg || 0;
    const egPrev = sums[prevKey]?.eg || 0;

    const canvas = element.querySelector('#grafico-egresos');
    const ctx = canvas.getContext('2d');
    
    if(window.chartEgresos) {
      window.chartEgresos.destroy();
    }
    
    window.chartEgresos = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Mes anterior', 'Mes actual'],
        datasets: [{
          label: 'Egresos',
          data: [egPrev, egActual],
          backgroundColor: ['rgba(255,180,180,0.6)', 'rgba(193,18,31,0.95)'],
          borderColor: ['rgba(255,120,120,0.9)', 'rgba(193,18,31,1)'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: false } 
        },
        scales: {
          y: { 
            ticks: { color: '#cbdff3' }, 
            beginAtZero: true 
          },
          x: { 
            ticks: { color: '#cbdff3' } 
          }
        }
      }
    });
  }
});

// Componente: Cuentas Pendientes
ComponentSystem.registrar('cuentasPendientes', {
  grid: 'full',
  html: `
    <h2>Cuentas Pendientes</h2>
    <div class="tabla-container" style="max-height:260px; overflow-y:auto; margin-top:12px;">
      <table id="tabla-pendientes" class="tabla-datos" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#0d1b2a; color:#fff;">
            <th>Fecha Emisión</th>
            <th>Tipo</th>
            <th>Cliente / Proveedor</th>
         
            <th>Importe</th>
       
            <th>Estado</th>
          </tr>
        </thead>
        <tbody style="background:#ffffff10; color:#e0e0e0;"></tbody>
      </table>
    </div>
  `,
  async render(data, element) {
    const hoja = data["Cuentas_Pendientes"];
    if(!hoja || !Array.isArray(hoja)) return;

    const pendientes = hoja.filter(r => 
      String(r["Estado (Pendiente/Pagado)"]).toLowerCase().includes("pendiente")
    );
    
    if(pendientes.length === 0) {
      element.querySelector('tbody').innerHTML = '<tr><td colspan="7">No hay cuentas pendientes</td></tr>';
      return;
    }

    pendientes.sort((a,b) => new Date(a["Fecha Emisión"]) - new Date(b["Fecha Emisión"]));

    const tbody = element.querySelector('tbody');
    tbody.innerHTML = '';
    
    pendientes.forEach(r => {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${UTILS.formatDate(r["Fecha Emisión"])}</td>
        <td style="color:${r["Tipo (A cobrar/A pagar)"].includes("cobrar") ? "#28a745" : "#dc3545"}">
          ${r["Tipo (A cobrar/A pagar)"]}
        </td>
        <td>${r["Cliente/Proveedor"] || ""}</td>
        <td>$ ${UTILS.parseNumber(r["Importe"]).toLocaleString("es-AR",{minimumFractionDigits:2})}</td>
        <td>${r["Estado (Pendiente/Pagado)"] || ""}</td>
      `;
      tbody.appendChild(fila);
    });

    // Inicializar DataTable
    const table = $(element).find('#tabla-pendientes');
    if($.fn.dataTable.isDataTable(table)) {
      table.DataTable().destroy();
    }
    
    table.DataTable({
      pageLength: 10,
      dom: 'Bfrtip',
      buttons: [{ extend: 'csv', text: 'Exportar CSV' }],
      language: { search: "Buscar:" },
      order: [[0, 'desc']]
    });
  }
});

// ====== EJEMPLO: CÓMO AGREGAR UN NUEVO COMPONENTE ======
/*
ComponentSystem.registrar('nuevoComponente', {
  grid: 'span-3', // Opciones: span-3, span-4, span-5, span-6, full
  html: `
    <h2>Mi Nuevo Componente</h2>
    <div class="chart-container">
      <canvas id="grafico-nuevo"></canvas>
    </div>
  `,
  async render(data, element) {
    // Tu lógica aquí para procesar datos y actualizar el HTML
    const contenido = element.querySelector('#contenido-nuevo');
    contenido.innerHTML = 'Datos procesados correctamente';
  }
});

// Luego agregarlo a componentesActivos:
// COMPONENTES.componentesActivos.push('nuevoComponente');
*/

// ====== CONTROLADOR PRINCIPAL ======
const DashboardApp = {
  async init() {
    this.setupEventListeners();
    await this.loadData();
  },

  setupEventListeners() {
    document.getElementById('refresh-data').addEventListener('click', () => this.loadData(true));
    document.getElementById('btn-export').addEventListener('click', this.exportData);
  },

  async loadData(force = false) {
    try {
      document.getElementById('estado').innerText = 'Cargando...';
      const data = await DataManager.fetchData(force);
      await ComponentSystem.render(data);
      document.getElementById('estado').innerText = 'Datos actualizados';
    } catch(error) {
      console.error('Error cargando datos:', error);
      document.getElementById('estado').innerText = 'Error: ' + error.message;
    }
  },

  exportData() {
    const table = $('#tabla-pendientes').DataTable();
    if(table) {
      table.button('.buttons-csv').trigger();
    }
  }
};

// ====== INICIALIZACIÓN ======
document.addEventListener('DOMContentLoaded', () => {
  DashboardApp.init();
});
</script>
</body>
</html>
