<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Financiero - HG Soluciones</title>

  <!-- Librerías -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

  <!-- Estilos -->
  <style>
    body {
      font-family: Calibri, sans-serif;
      margin: 0; padding: 0;
      background: #f5f6fa;
      color: #333;
    }
    header {
      background: #23395b;
      color: white;
      padding: 20px;
      text-align: center;
    }
    main { padding: 20px; }
    .section {
      margin-bottom: 40px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h2 { color: #23395b; }
    canvas { max-width: 100%; margin-top: 20px; }
    .kpi-container {
      display: flex; flex-wrap: wrap;
      gap: 15px; margin-bottom: 25px;
    }
    .kpi {
      flex: 1;
      min-width: 150px;
      background: #eef2f6;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    .kpi h3 { margin: 5px 0; color: #23395b; }
    .kpi p { font-size: 1.3em; margin: 0; }
    footer {
      background: #23395b;
      color: #fff;
      text-align: center;
      padding: 10px;
      margin-top: 40px;
    }
  </style>
</head>

<body>
  <header>
    <h1>HG Soluciones Administrativas</h1>
    <p>Dashboard Financiero Integrado</p>
  </header>

  <main>
    <!-- KPIs -->
    <section class="section">
      <h2>Resumen General</h2>
      <div class="kpi-container">
        <div class="kpi"><h3>Ingresos</h3><p id="kpiIngresos">–</p></div>
        <div class="kpi"><h3>Egresos</h3><p id="kpiEgresos">–</p></div>
        <div class="kpi"><h3>Balance</h3><p id="kpiBalance">–</p></div>
      </div>
    </section>

    <!-- Finanzas -->
    <section class="section">
      <h2>Finanzas Registradas</h2>
      <table id="tablaFinanzas" class="display"></table>
      <canvas id="graficoFinanzas"></canvas>
    </section>

    <!-- Ventas -->
    <section class="section">
      <h2>Ventas Diarias</h2>
      <table id="tablaVentas" class="display"></table>
      <canvas id="graficoVentas"></canvas>
    </section>
  </main>

  <footer>
    <p>© 2025 HG Soluciones Administrativas | Dashboard financiero conectado a Google Sheets</p>
  </footer>

  <script>
    const SHEET_ID = "1ljNxLlIV7mExU3yp3g74AeDshTphT2deD4xXhlR1saU";

    async function cargarHoja(nombreHoja) {
      const url = `https://opensheet.elk.sh/${SHEET_ID}/${nombreHoja}`;
      const res = await fetch(url);
      return await res.json();
    }

    async function iniciarDashboard() {
      const finanzas = await cargarHoja("Finanzas_RegistroDiario");
      const ventas = await cargarHoja("Ventas_RegistroDiario");

      // --- KPIs ---
      const ingresos = finanzas.filter(f => f.Tipo?.toLowerCase().includes("ingreso"))
        .reduce((s, f) => s + (parseFloat(f.Monto.replace(",", ".")) || 0), 0);
      const egresos = finanzas.filter(f => f.Tipo?.toLowerCase().includes("egreso"))
        .reduce((s, f) => s + (parseFloat(f.Monto.replace(",", ".")) || 0), 0);
      const balance = ingresos - egresos;

      document.getElementById("kpiIngresos").textContent = `$${ingresos.toLocaleString()}`;
      document.getElementById("kpiEgresos").textContent = `$${egresos.toLocaleString()}`;
      document.getElementById("kpiBalance").textContent = `$${balance.toLocaleString()}`;

      // --- Tabla Finanzas ---
      const tablaF = document.getElementById("tablaFinanzas");
      const headersF = Object.keys(finanzas[0]);
      tablaF.innerHTML = `
        <thead><tr>${headersF.map(h => `<th>${h}</th>`).join('')}</tr></thead>
        <tbody>${finanzas.map(r => `<tr>${headersF.map(h => `<td>${r[h]}</td>`).join('')}</tr>`).join('')}</tbody>
      `;
      new DataTable(tablaF);

      // --- Gráfico Finanzas ---
      const fechas = finanzas.map(f => f.Fecha);
      const montos = finanzas.map(f => parseFloat(f.Monto.replace(",", ".")) || 0);
      const ctxF = document.getElementById("graficoFinanzas").getContext("2d");
      new Chart(ctxF, {
        type: "bar",
        data: {
          labels: fechas,
          datasets: [{
            label: "Movimientos ($)",
            data: montos,
            backgroundColor: "rgba(54,162,235,0.6)"
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } } }
      });

      // --- Tabla Ventas ---
      const tablaV = document.getElementById("tablaVentas");
      const headersV = Object.keys(ventas[0]);
      tablaV.innerHTML = `
        <thead><tr>${headersV.map(h => `<th>${h}</th>`).join('')}</tr></thead>
        <tbody>${ventas.map(r => `<tr>${headersV.map(h => `<td>${r[h]}</td>`).join('')}</tr>`).join('')}</tbody>
      `;
      new DataTable(tablaV);

      // --- Gráfico Ventas ---
      const ctxV = document.getElementById("graficoVentas").getContext("2d");
      const ventasPorDia = {};
      ventas.forEach(v => {
        const dia = v.Fecha;
        const total = parseFloat(v.Total?.replace(",", ".")) || 0;
        ventasPorDia[dia] = (ventasPorDia[dia] || 0) + total;
      });
      const dias = Object.keys(ventasPorDia);
      const totales = Object.values(ventasPorDia);

      new Chart(ctxV, {
        type: "line",
        data: {
          labels: dias,
          datasets: [{
            label: "Ventas Totales ($)",
            data: totales,
            borderColor: "rgba(75,192,192,1)",
            backgroundColor: "rgba(75,192,192,0.2)",
            fill: true,
            tension: 0.3
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } } }
      });
    }

    iniciarDashboard();
  </script>
</body>
</html>
