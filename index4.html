<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Financiero - HG Soluciones</title>

<!-- CSS: kept exactly the HG look you provided -->
<link href="https://cdn.jsdelivr.net/npm/datatables.net-dt@1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/datatables.net-buttons-dt@2.4.1/css/buttons.dataTables.min.css" rel="stylesheet"/>
<style>
:root{
  --bg: #0f1724;
  --card: #0b1220;
  --accent: #3ea6ff;
  --accent-2: #7b61ff;
  --muted: #9aa8ba;
  --glass: rgba(255,255,255,0.03);
  --text: #e6eef8;
  --card-contrast: rgba(255,255,255,0.02);
  font-family: Inter, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  --radius: 12px;
}

/* Page */
html,body{
  height:100%;
  margin:0;
  background: linear-gradient(180deg,#071226 0%, #081426 100%);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Sidebar basic (kept from your layout) */
.app{display:flex; min-height:100vh;}
aside.sidebar{width:260px; background:linear-gradient(180deg, rgba(11,18,32,0.9), rgba(6,10,18,0.85)); padding:18px; box-shadow: 0 6px 24px rgba(2,6,12,0.6);}
aside h1{font-size:18px; margin:0 0 12px; letter-spacing:0.6px; color:var(--accent);}
aside .nav{display:flex; flex-direction:column; gap:8px;}
aside .nav button{background:transparent; border:0; color:var(--muted); text-align:left; padding:10px; border-radius:8px; cursor:pointer;}
aside .nav button.active, aside .nav button:hover{background:var(--glass); color:#fff;}

main{flex:1; padding:18px; display:flex; flex-direction:column; gap:12px;}

/* Header */
.header-hg{
  padding:0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:4px;
}
.header-hg h1{
  margin:0;
  font-size:18px;
  color:var(--accent);
  letter-spacing:0.4px;
}
.header-hg p{ margin:0; color:var(--muted); font-size:13px; }

/* Layout grid */
.dashboard-grid{
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 12px;
  padding: 0 0 12px 0;
  align-items: start;
}

/* Cards + panels */
.card, .panel{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 6px 20px rgba(3,7,12,0.6);
  border: 1px solid rgba(255,255,255,0.02);
}

/* Grid placements */
#bloque-saldo{ grid-column: span 3; min-height:110px; display:flex; flex-direction:column; justify-content:center; }
#bloque-ingresos{ grid-column: span 5; min-height:220px; }
#bloque-egresos{ grid-column: span 4; min-height:220px; }
#bloque-pendientes{ grid-column: 1 / -1; } /* wide full width */

/* KPI grande */
.kpi-grande{
  font-size:28px;
  font-weight:800;
  color:#ffffff;
  margin-top:8px;
  letter-spacing:0.4px;
}

/* Headings inside cards */
.card h2{
  margin:0;
  font-size:14px;
  color:var(--muted);
  font-weight:600;
  margin-bottom:8px;
}

/* Canvas full width */
canvas{ width:100% !important; height: auto !important; }

/* Table styles */
table.display{
  width:100%;
  border-collapse:collapse;
}
table.display thead th{
  background: transparent;
  color:var(--muted);
  font-weight:600;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  padding:10px 8px;
  text-align:left;
  font-size:13px;
}
table.display tbody td{
  padding:10px 8px;
  color:var(--text);
  border-bottom: 1px dashed rgba(255,255,255,0.02);
  font-size:13px;
}

/* Buttons (reuse style from main layout) */
.btn{
  background:var(--accent);
  color:#00121a;
  border:0;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.btn.secondary{
  background:transparent;
  color:var(--muted);
  border:1px solid rgba(255,255,255,0.04);
}

/* Footer */
.footer-hg{
  padding:12px 18px;
  color:var(--muted);
  font-size:13px;
  border-top:1px solid rgba(255,255,255,0.02);
  margin-top:18px;
}

/* Responsive */
@media (max-width:1200px){
  #bloque-saldo{ grid-column: span 4; }
  #bloque-ingresos{ grid-column: span 8; }
  #bloque-egresos{ grid-column: span 8; }
  #bloque-pendientes{ grid-column: 1 / -1; }
}
@media (max-width:900px){
  .dashboard-grid{ grid-template-columns: repeat(6, 1fr); padding:12px; }
  #bloque-saldo{ grid-column: span 6; order:0; }
  #bloque-ingresos{ grid-column: span 6; order:1; }
  #bloque-egresos{ grid-column: span 6; order:2; }
  #bloque-pendientes{ grid-column: span 6; order:3; }
}
@media (max-width:600px){
  .dashboard-grid{ grid-template-columns: repeat(1, 1fr); }
  #bloque-saldo,#bloque-ingresos,#bloque-egresos,#bloque-pendientes{ grid-column: span 1; }
}

/* Small helpers */
.text-muted{ color:var(--muted); font-size:13px; }
.kpi-small{ font-size:13px; color:var(--muted); }

/* DataTables override for dark theme */
.dataTables_wrapper .dataTables_filter input { background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:6px; border-radius:6px; }
.dataTables_wrapper .dataTables_length select { background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:6px; border-radius:6px; }
.dataTables_wrapper .dt-buttons .dt-button { background: transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); border-radius:8px; padding:6px 8px; margin-right:6px; }

/* subtle hover */
.card:hover{ transform: translateY(-4px); transition: all 220ms ease; box-shadow: 0 12px 28px rgba(2,6,12,0.6); }

/* tiny loader */
.loader{ display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.06); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
@keyframes spin{ to{ transform:rotate(360deg); } }
  
/* Corrige comportamiento de expansión de Chart.js */
.card canvas {
  width: 100% !important;
  height: 260px !important; /* altura estable */
  max-height: 260px;
  display: block;
}

.card {
  overflow: hidden; /* evita que crezca fuera del contenedor */
}

@media (max-width: 768px) {
  .card canvas {
    height: 200px !important;
  }
}

</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" role="navigation">
    <h1>HG - Dashboard Financiero</h1>
    <div class="nav">
      <button id="nav-overview" class="active">Resumen</button>
      <button id="nav-ventas">Ventas</button>
      <button id="nav-finanzas">Finanzas</button>
      <button id="nav-simulador">Simulador</button>
      <button id="nav-tablas">Tablas</button>
    </div>
    <footer style="margin-top:14px;color:var(--muted);font-size:12px">
      <div>Conexión: <span id="conn-status">sin iniciar</span></div>
      <div style="margin-top:8px"><button class="btn small" id="refresh-data">Actualizar datos</button></div>
    </footer>
  </aside>

  <main>
    <header class="topbar header-hg" style="display:flex; align-items:center; gap:12px;">
      <div>
        <h1 style="margin:0">Dashboard Financiero</h1>
        <p style="margin:0; color:var(--muted); font-size:13px">Conexión en vivo a Google Sheets — estilo HG</p>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <div id="estado" class="text-muted">Esperando datos...</div>
        <button id="btn-export" class="btn small">Exportar CSV</button>
      </div>
    </header>

    <div class="dashboard-grid" style="margin-top:12px;">
      <section id="bloque-saldo" class="card">
        <h2>Saldo de caja</h2>
        <div id="saldo-actual" class="kpi-grande">Cargando...</div>
        <div id="saldo-fecha" class="text-muted" style="margin-top:6px;">—</div>
      </section>

      <section id="bloque-ingresos" class="card">
        <h2>Ingresos: mes actual vs mes anterior</h2>
        <canvas id="grafico-ingresos" height="180"></canvas>
      </section>

      <section id="bloque-egresos" class="card">
        <h2>Egresos: mes actual vs mes anterior</h2>
        <canvas id="grafico-egresos" height="180"></canvas>
      </section>

      <section id="bloque-pendientes" class="card">
        <h2>Cuentas Pendientes</h2>
        <div class="table-wrap" style="margin-top:8px;">
          <table id="tabla-pendientes" class="display stripe" style="width:100%">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Código</th>
                <th>Nombre</th>
                <th>Monto</th>
                <th>Saldo</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer class="footer-hg">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="text-muted">Última sincronización: <span id="last-sync">nunca</span></div>
        <div class="text-muted">Cache: <span id="cache-status">no</span></div>
      </div>
    </footer>
  </main>
</div>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-buttons@2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-buttons@2.4.1/js/buttons.html5.min.js"></script>

<script>
// ====== CONFIG ======
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyTLrGiqes1VOp8E51Kq91P7YihPKNtN1f0f6u2JitXOteGyGrNXqiSjdXYJ8HAtfs/exec";
const CACHE_KEY = "hg_dashboard_cache_v3";
const CACHE_TTL = 1000 * 60 * 60; // 1h

// ====== UTIL ======
function saveCache(obj){ localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), data:obj})); document.getElementById('cache-status').innerText='sí'; }
function loadCache(){ try{ const raw=localStorage.getItem(CACHE_KEY); if(!raw) return null; const parsed=JSON.parse(raw); if(Date.now()-parsed.ts > CACHE_TTL) return null; return parsed.data;}catch(e){return null;} }
function parseNumber(val){
  if(val === null || val === undefined || val === "") return 0;
  if(typeof val === "number") return val;
  const s = String(val).replace(/[^0-9\-,\.]/g,"").trim();
  if(!s) return 0;
  // handle formats like "1.234,56" or "1234.56"
  const parts = s.split(',');
  if(parts.length > 1 && parts[0].includes('.')) {
    // "1.234,56" -> remove dots, replace comma with dot
    return parseFloat(s.replace(/\./g,'').replace(',','.')) || 0;
  } else {
    return parseFloat(s.replace(',', '.')) || 0;
  }
}
function parseDate(v){
  if(!v) return new Date(NaN);
  if(v instanceof Date) return v;
  const s = String(v).trim();
  if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
  if(/^\d{2}\/\d{2}\/\d{4}/.test(s)){ const [d,m,y]=s.split('/'); return new Date(Number(y),Number(m)-1,Number(d)); }
  const n = Number(s);
  if(!isNaN(n) && n > 1000){ // serial
    const epoch = new Date(Date.UTC(1899,11,30));
    epoch.setUTCDate(epoch.getUTCDate() + Math.floor(n));
    return epoch;
  }
  const d = new Date(s);
  return d;
}
function formatCurrency(n){
  const sign = n < 0 ? '-' : '';
  const abs = Math.abs(Number(n) || 0);
  return sign + '$' + abs.toLocaleString('es-AR', {minimumFractionDigits:0, maximumFractionDigits:0});
}

// ====== FETCH ======
async function fetchAllFromGAS(force=false){
  if(!force){
    const cached = loadCache();
    if(cached){ document.getElementById('conn-status').innerText='cache local'; return cached; }
  }
  document.getElementById('conn-status').innerText='cargando...';
  const res = await fetch(GAS_ENDPOINT);
  if(!res.ok) throw new Error('Error al consultar endpoint: ' + res.status);
  const data = await res.json();
  saveCache(data);
  document.getElementById('conn-status').innerText='conectado';
  document.getElementById('last-sync').innerText = new Date().toLocaleString();
  return data;
}

// ====== RENDER SALDO (detect 'saldo' column) ======
function renderSaldoCaja(data){
  const arr = data.Caja_Movimientos || data.caja_movimientos || data['Caja_Movimientos'] || [];
  if(!arr || arr.length === 0){
    document.getElementById('saldo-actual').innerText = 'Sin datos';
    document.getElementById('saldo-fecha').innerText = '';
    return;
  }

  // detect saldo column (case-insensitive)
  const sample = arr.find(r => r && typeof r === 'object');
  const keys = sample ? Object.keys(sample) : [];
  const saldoKey = keys.find(k => /saldo/i.test(k));
  if(saldoKey){
    // find last non-empty saldo reading from bottom
    let lastVal = null;
    let lastRow = null;
    for(let i=arr.length-1;i>=0;i--){
      const v = arr[i][saldoKey];
      if(v !== null && v !== undefined && String(v).trim() !== ''){
        lastVal = v;
        lastRow = arr[i];
        break;
      }
    }
    const numeric = parseNumber(lastVal);
    document.getElementById('saldo-actual').innerText = formatCurrency(numeric);
    // date if available
    const dateKey = keys.find(k => /fecha|date/i.test(k));
    if(lastRow && dateKey && lastRow[dateKey]){
      const pd = parseDate(lastRow[dateKey]);
      if(!isNaN(pd.getTime())) document.getElementById('saldo-fecha').innerText = 'Saldo registrado al ' + (pd.getDate()+"/"+(pd.getMonth()+1)+"/"+pd.getFullYear());
    } else {
      document.getElementById('saldo-fecha').innerText = '';
    }
    return;
  }

  // fallback: compute running balance from ingreso/egreso or monto and tipo
  let saldo=0, lastDate=null;
  const ingestionKeys = keys.filter(k => /ingres/i.test(k) || /monto/i.test(k) || /importe/i.test(k));
  const egKeys = keys.filter(k => /egres/i.test(k) || /monto/i.test(k) || /importe/i.test(k));
  const tipoKey = keys.find(k => /tipo/i.test(k) || /ingre/i.test(k) || /egre/i.test(k));
  for(const row of arr){
    lastDate = row['Fecha'] || row['fecha'] || row['Date'] || lastDate;
    // if there's explicit 'Tipo' column, use it
    if(tipoKey && row[tipoKey]){
      const tipo = String(row[tipoKey]).toLowerCase();
      // get any numeric from ingestionKeys
      const monto = parseNumber((ingestionKeys.map(k=>row[k]).find(v=>v!==undefined) || 0));
      if(tipo.includes('ingre')) saldo += monto;
      else if(tipo.includes('egre')) saldo -= monto;
      else saldo += monto; // fallback
    } else {
      // try interpret amounts: positive -> ingreso, negative -> egreso
      const val = parseNumber((ingestionKeys.map(k=>row[k]).find(v=>v!==undefined) || 0));
      saldo += val;
    }
  }
  document.getElementById('saldo-actual').innerText = formatCurrency(saldo);
  if(lastDate){
    const pd = parseDate(lastDate);
    if(!isNaN(pd.getTime())) document.getElementById('saldo-fecha').innerText = 'Saldo calculado al ' + (pd.getDate()+"/"+(pd.getMonth()+1)+"/"+pd.getFullYear());
  }
}

// ====== RENDER Ingresos/Egresos (mes actual vs mes anterior) ======
function renderIngresosEgresos(data){
  const fin = data.Finanzas_RegistroDiario || data['Finanzas_RegistroDiario'] || data.finanzas_registrodiario || data['finanzas_registrodiario'] || data.Caja_Movimientos || [];
  // detect keys
  const sample = fin.find(r => r && typeof r === 'object') || {};
  const keys = Object.keys(sample);
  const montoKey = keys.find(k => /monto|importe|total/i.test(k)) || null;
  const tipoKey = keys.find(k => /tipo|ingres|egres/i.test(k)) || null;
  const fechaKey = keys.find(k => /fecha|date/i.test(k)) || null;
  // accumulate sums by YYYY-MM
  const sums = {};
  for(const row of fin){
    const rawFecha = row[fechaKey] ?? row['Fecha'] ?? row['fecha'] ?? row['Date'] ?? null;
    const d = parseDate(rawFecha);
    const key = (!isNaN(d.getTime())) ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` : 'sin-fecha';
    if(!sums[key]) sums[key] = {ing:0, eg:0};
    const tipo = String(row[tipoKey] ?? '').toLowerCase();
    const monto = parseNumber(row[montoKey] ?? row['Monto'] ?? row['Importe'] ?? row['Total'] ?? 0);
    if(tipoKey && tipo.includes('ingre')) sums[key].ing += monto;
    else if(tipoKey && tipo.includes('egre')) sums[key].eg += Math.abs(monto);
    else {
      // heuristic: positive -> ingreso, negative -> egreso
      if(monto >= 0) sums[key].ing += monto;
      else sums[key].eg += Math.abs(monto);
    }
  }

  const today = new Date();
  const curKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  const prev = new Date(today.getFullYear(), today.getMonth()-1, 1);
  const prevKey = `${prev.getFullYear()}-${String(prev.getMonth()+1).padStart(2,'0')}`;

  const ingActual = sums[curKey]?.ing || 0;
  const ingPrev = sums[prevKey]?.ing || 0;
  const egActual = sums[curKey]?.eg || 0;
  const egPrev = sums[prevKey]?.eg || 0;

  // Ingresos chart
  const ctxI = document.getElementById('grafico-ingresos').getContext('2d');
  if(window.chartIngresos) window.chartIngresos.destroy();
  window.chartIngresos = new Chart(ctxI, {
    type:'bar',
    data:{
      labels:['Mes anterior','Mes actual'],
      datasets:[{
        label:'Ingresos',
        data:[ingPrev, ingActual],
        backgroundColor:['rgba(58,123,213,0.35)','rgba(62,166,255,0.9)'],
        borderColor:['rgba(58,123,213,0.8)','rgba(62,166,255,1)'],
        borderWidth:1
      }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{ticks:{color:'#cbdff3'}, beginAtZero:true}, x:{ticks:{color:'#cbdff3'}}} }
  });

  // Egresos chart
  const ctxE = document.getElementById('grafico-egresos').getContext('2d');
  if(window.chartEgresos) window.chartEgresos.destroy();
  window.chartEgresos = new Chart(ctxE, {
    type:'bar',
    data:{
      labels:['Mes anterior','Mes actual'],
      datasets:[{
        label:'Egresos',
        data:[egPrev, egActual],
        backgroundColor:['rgba(255,180,180,0.6)','rgba(193,18,31,0.95)'],
        borderColor:['rgba(255,120,120,0.9)','rgba(193,18,31,1)'],
        borderWidth:1
      }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{ticks:{color:'#cbdff3'}, beginAtZero:true}, x:{ticks:{color:'#cbdff3'}}} }
  });
}

// ====== RENDER tabla últimos movimientos (general: caja/finanzas) ======
function renderRecentMovements(data){
  // prefer Caja_Movimientos for movements if exists, else Finanzas_RegistroDiario
  const arr = data.Caja_Movimientos || data.caja_movimientos || data['Caja_Movimientos'] || data.Finanzas_RegistroDiario || data['Finanzas_RegistroDiario'] || [];
  if(!arr || arr.length === 0){
    // clear table
    const tbody = document.querySelector('#tabla-pendientes tbody');
    tbody.innerHTML = '<tr><td colspan="7">No hay movimientos</td></tr>';
    return;
  }

  // determine typical keys
  const sample = arr.find(r => r && typeof r === 'object') || {};
  const keys = Object.keys(sample);
  const fechaKey = keys.find(k => /fecha|date/i.test(k)) || null;
  const tipoKey = keys.find(k => /tipo/i.test(k)) || null;
  const codigoKey = keys.find(k => /codigo|id/i.test(k)) || null;
  const nombreKey = keys.find(k => /cliente|proveedor|nombre|razon|empresa/i.test(k)) || null;
  const montoKey = keys.find(k => /monto|importe|total/i.test(k)) || null;
  const saldoKey = keys.find(k => /saldo/i.test(k)) || null;
  const estadoKey = keys.find(k => /estado|situación|situacion/i.test(k)) || null;

  // sort by date desc (where possible)
  const withDates = arr.map(r => ({_r:r, _d: parseDate(r[fechaKey] ?? r['Fecha'] ?? r['fecha'] ?? r['Date'] ?? null)}));
  withDates.sort((a,b)=> (isNaN(b._d)?0:b._d.getTime()) - (isNaN(a._d)?0:a._d.getTime()));
  const recent = withDates.slice(0, 50).map(x => x._r);

  const tbody = document.querySelector('#tabla-pendientes tbody');
  tbody.innerHTML = '';
  for(const r of recent){
    const fecha = r[fechaKey] ?? r['Fecha'] ?? r['fecha'] ?? r['Date'] ?? '';
    const tipo = r[tipoKey] ?? r['Tipo'] ?? '';
    const codigo = r[codigoKey] ?? r['Código'] ?? r['Codigo'] ?? '';
    const nombre = r[nombreKey] ?? r['Cliente'] ?? r['Proveedor'] ?? '';
    const monto = parseNumber(r[montoKey] ?? r['Monto'] ?? r['Importe'] ?? r['Total'] ?? 0);
    const saldo = parseNumber(r[saldoKey] ?? r['Saldo'] ?? '');
    const estado = r[estadoKey] ?? r['Estado'] ?? '';

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fecha ?? ''}</td>
                    <td>${tipo ?? ''}</td>
                    <td>${codigo ?? ''}</td>
                    <td>${nombre ?? ''}</td>
                    <td style="text-align:right">${formatCurrency(monto)}</td>
                    <td style="text-align:right">${saldo ? formatCurrency(saldo) : ''}</td>
                    <td>${estado ?? ''}</td>`;
    tbody.appendChild(tr);
  }

  // init DataTable (or refresh)
  const table = $('#tabla-pendientes');
  if($.fn.dataTable.isDataTable(table)){
    table.DataTable().destroy();
  }
  table.DataTable({
    pageLength: 10,
    dom: 'Bfrtip',
    buttons:[ { extend: 'csv', text: 'Exportar CSV' }, { extend: 'excel', text: 'Exportar Excel' } ],
    language: { search: "Buscar:" },
    columnDefs: [{ targets:[4,5], className: 'dt-body-right' }],
    order: [[0,'desc']]
  });
}

// ====== ORQUESTADOR ======
async function refreshAll(force=false){
  try{
    document.getElementById('estado').innerText = 'Cargando...';
    const data = await fetchAllFromGAS(force);
    window.DATA = data;
    renderSaldoCaja(data);
    renderIngresosEgresos(data);
    renderRecentMovements(data);
    document.getElementById('estado').innerText = 'Datos actualizados';
  }catch(err){
    console.error('Error refreshAll:', err);
    document.getElementById('estado').innerText = 'Error: ' + (err.message || err);
  }
}

// UI wiring
document.getElementById('refresh-data').addEventListener('click', ()=> refreshAll(true));
document.getElementById('btn-export').addEventListener('click', ()=>{
  // export current pendientes table to CSV by reading DOM
  const table = $('#tabla-pendientes').DataTable();
  table.button('.buttons-csv').trigger();
});

// startup
refreshAll(false);
</script>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyTLrGiqes1VOp8E51Kq91P7YihPKNtN1f0f6u2JitXOteGyGrNXqiSjdXYJ8HAtfs/exec";

// Variable global para evitar recargas múltiples
let dashboardInicializado = false;

// === FUNCIÓN PRINCIPAL ===
async function cargarDashboardUnaVez() {
  if (dashboardInicializado) return; // Previene redibujos infinitos
  dashboardInicializado = true;

  try {
    const res = await fetch(GAS_URL, { cache: "no-store" });
    const data = await res.json();

    const caja = data["Caja_Movimientos"] || [];
    if (!caja.length) return console.warn("Sin datos en Caja_Movimientos");

    actualizarSaldo(caja);
    renderizarGraficos(caja);
  } catch (err) {
    console.error("Error al cargar datos:", err);
  }
}

// === SALDO ACTUAL ===
function actualizarSaldo(datos) {
  const colSaldo = Object.keys(datos[0]).find(k => k.toLowerCase().includes("saldo"));
  const saldo = parseFloat(datos[datos.length - 1][colSaldo]) || 0;
  document.getElementById("saldo-actual").innerText = 
    "$ " + saldo.toLocaleString("es-AR", { minimumFractionDigits: 2 });
}

// === PROCESAR Y GRAFICAR ===
function renderizarGraficos(datos) {
  const colFecha = Object.keys(datos[0]).find(k => k.toLowerCase().includes("fecha"));
  const colTipo = Object.keys(datos[0]).find(k => k.toLowerCase().includes("tipo"));
  const colMonto = Object.keys(datos[0]).find(k => k.toLowerCase().includes("monto"));

  const totales = {};
  datos.forEach(r => {
    const fecha = new Date(r[colFecha]);
    if (isNaN(fecha)) return;
    const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, "0")}`;
    const tipo = (r[colTipo] || "").toLowerCase();
    const monto = parseFloat(r[colMonto]) || 0;
    if (!totales[mes]) totales[mes] = { ingreso: 0, egreso: 0 };
    if (tipo.includes("ingreso")) totales[mes].ingreso += monto;
    else if (tipo.includes("egreso")) totales[mes].egreso += monto;
  });

  const meses = Object.keys(totales).sort();
  const ingresos = meses.map(m => totales[m].ingreso);
  const egresos = meses.map(m => totales[m].egreso);
  const saldos = meses.map(m => totales[m].ingreso - totales[m].egreso);

  // Destruir si existen, evitando fugas de memoria
  ["Ingresos", "Egresos", "Saldo"].forEach(id => {
    const chartKey = `chart${id}`;
    if (window[chartKey]) {
      window[chartKey].destroy();
      window[chartKey] = null;
    }
  });

  // === GRAFICO INGRESOS ===
  const ctx1 = document.getElementById("graficoIngresos").getContext("2d");
  window.chartIngresos = new Chart(ctx1, {
    type: "bar",
    data: {
      labels: meses,
      datasets: [{
        label: "Ingresos",
        data: ingresos,
        backgroundColor: "#00c853cc",
        borderColor: "#00c853",
        borderWidth: 1
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, animation: false }
  });

  // === GRAFICO EGRESOS ===
  const ctx2 = document.getElementById("graficoEgresos").getContext("2d");
  window.chartEgresos = new Chart(ctx2, {
    type: "bar",
    data: {
      labels: meses,
      datasets: [{
        label: "Egresos",
        data: egresos,
        backgroundColor: "#d50000cc",
        borderColor: "#d50000",
        borderWidth: 1
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, animation: false }
  });

  // === GRAFICO SALDO ===
  const ctx3 = document.getElementById("graficoSaldo").getContext("2d");
  window.chartSaldo = new Chart(ctx3, {
    type: "line",
    data: {
      labels: meses,
      datasets: [{
        label: "Saldo Mensual (Ingresos - Egresos)",
        data: saldos,
        fill: true,
        backgroundColor: "#2962ff33",
        borderColor: "#2962ff",
        tension: 0.3
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, animation: false }
  });
}

// === INICIO ===
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(cargarDashboardUnaVez, 300); // pequeña espera para asegurar carga del DOM
});
</script>
</body>
</html>
