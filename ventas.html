[file name]: ventas.html
[file content begin]
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n de Ventas - HG Soluciones</title>
  
  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-dt@1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-buttons-dt@2.4.1/css/buttons.dataTables.min.css" rel="stylesheet"/>
  <link href="css/styles.css" rel="stylesheet">
  
<style>
  /* ... TODO tu CSS actual ... (mant√©n todo lo que tienes) ... */

  /* ====== AGREGAR AL FINAL DEL CSS ====== */
  /* Estilos para actualizaci√≥n en tiempo real - MEJORADOS */
  .pending-record {
    background: linear-gradient(90deg, rgba(62, 166, 255, 0.05), transparent) !important;
    border-left: 3px solid var(--accent) !important;
  }

  .pending-cell {
    font-style: italic;
    color: var(--muted) !important;
  }

  .confirmed-record {
    animation: highlightConfirm 1.5s ease;
  }

  @keyframes highlightConfirm {
    0% { background: rgba(40, 167, 69, 0.2); }
    50% { background: rgba(40, 167, 69, 0.1); }
    100% { background: transparent; }
  }

  /* Notificaciones Toast - MEJORADAS */
  #toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .toast-notification {
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 12px 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
    min-width: 280px;
    max-width: 350px;
  }

  .toast-notification.show {
    transform: translateX(0);
    opacity: 1;
  }

  .toast-notification.success {
    border-left: 4px solid #28a745;
  }

  .toast-notification.error {
    border-left: 4px solid #dc3545;
  }

  .toast-notification.info {
    border-left: 4px solid var(--accent);
  }

  .toast-content {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text);
    font-size: 14px;
  }

  .toast-content i {
    font-size: 16px;
  }

  /* Loader peque√±o para botones - MEJORADO */
  .btn .loader {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: currentColor;
    animation: spin 1s ease-in-out infinite;
    margin-right: 6px;
  }

  /* Animaci√≥n de entrada para nuevas filas - MEJORADA */
  .fade-in {
    animation: fadeInUp 0.4s ease-out;
  }

  @keyframes fadeInUp {
    from { 
      opacity: 0; 
      transform: translateY(-8px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }

  /* Estado de bot√≥n deshabilitado */
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }
</style>
</head>
<body>
  <!-- Pantalla de carga - SOLO PARA OPERACIONES CR√çTICAS -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner">
        <div class="spinner-circle"></div>
        <div class="spinner-circle"></div>
        <div class="spinner-circle"></div>
      </div>
      <h3 class="loading-title">Procesando informaci√≥n</h3>
      <p class="loading-message" id="loading-message">Por favor espere...</p>
    </div>
  </div>

  <div class="app">
    <!--<aside class="sidebar" role="navigation">
      <h1>HG - Gesti√≥n de Ventas</h1>
      <div class="nav">
        <button id="nav-dashboard" onclick="location.href='dash_beta.html'">Dashboard</button>
        <button id="nav-carga-datos" onclick="location.href='carga_datos.html'">Carga de Datos</button>
        <button id="nav-clientes" onclick="location.href='abmclients2.html'">Gesti√≥n de Clientes</button>
        <button id="nav-proveedores" onclick="location.href='proveedores.html'">Gesti√≥n de Proveedores</button>
        <button id="nav-compras" onclick="location.href='compras.html'">Gesti√≥n de Compras</button>
        <button id="nav-ventas" class="active">Ventas</button>
        <button id="nav-finanzas">Finanzas</button>
        <button id="nav-simulador">Simulador</button>
        <button id="nav-tablas">Tablas</button>
      </div>
      <footer style="margin-top:14px;color:var(--muted);font-size:12px">
        <div>Conexi√≥n: <span id="conn-status">sin iniciar</span></div>
        <div style="margin-top:8px"><button class="btn small" id="refresh-data">Actualizar datos</button></div>
      </footer>
    </aside>-->

    <main>
      <header class="topbar header-hg" style="display:flex; align-items:center; gap:12px;">
        <button id="menu-toggle" class="menu-toggle">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 6H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        
        <div style="flex: 1;">
          <h1 style="margin:0;">Gesti√≥n de Ventas</h1>
          <p style="margin:0; color:var(--muted); font-size:13px">Registro y seguimiento de ventas e ingresos</p>
        </div>
        
        <div style="display:flex; gap:8px; align-items:center;">
          <div id="estado" class="text-muted">Esperando datos...</div>
        </div>
      </header>

      <!-- Overlay para m√≥viles -->
      <div id="sidebar-overlay" class="sidebar-overlay"></div>

      <!-- FORMULARIO DE VENTA -->
      <div class="card" data-grid="full" style="margin-bottom: 20px;">
        <h2 style="margin-top: 0; margin-bottom: 20px;" id="form-title">Nueva Venta</h2>
        
        <form id="form-venta">
          <!-- Secci√≥n: Informaci√≥n B√°sica -->
          <div class="form-section">
            <h3>Informaci√≥n B√°sica</h3>
            <div class="form-grid">
              <div class="form-field required">
                <label for="fecha">Fecha</label>
                <input type="date" id="fecha" name="fecha" required>
              </div>
              
              <div class="form-field required">
                <label for="cliente">Cliente</label>
                <select id="cliente" name="cliente" required>
                  <option value="">Seleccionar cliente...</option>
                  <!-- Se llenar√° din√°micamente con clientes activos -->
                </select>
              </div>
              
              <div class="form-field required">
                <label for="descripcion">Descripci√≥n</label>
                <input type="text" id="descripcion" name="descripcion" required placeholder="Descripci√≥n de la venta">
              </div>
              
              <div class="form-field">
                <label for="comprobante">N¬∞ Comprobante</label>
                <input type="text" id="comprobante" name="comprobante" placeholder="N√∫mero de factura/recibo">
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Monto y Categorizaci√≥n -->
          <div class="form-section">
            <h3>Monto y Categorizaci√≥n</h3>
            <div class="form-grid">
              <div class="form-field required">
                <label for="monto">Monto</label>
                <input type="number" id="monto" name="monto" min="0" step="0.01" required placeholder="0.00">
              </div>
              
              <div class="form-field required">
                <label for="categoria">Categor√≠a</label>
                <select id="categoria" name="categoria" required>
                  <option value="">Seleccionar categor√≠a...</option>
                  <option value="Productos">Productos</option>
                  <option value="Servicios">Servicios</option>
                  <option value="Consultor√≠a">Consultor√≠a</option>
                  <option value="Desarrollo">Desarrollo</option>
                  <option value="Mantenimiento">Mantenimiento</option>
                  <option value="Licencias">Licencias</option>
                  <option value="Alquileres">Alquileres</option>
                  <option value="Honorarios">Honorarios</option>
                  <option value="Intereses">Intereses</option>
                  <option value="Otros">Otros</option>
                </select>
              </div>
              
              <div class="form-field">
                <label for="subcategoria">Subcategor√≠a</label>
                <input type="text" id="subcategoria" name="subcategoria" placeholder="Subcategor√≠a espec√≠fica">
              </div>
              
              <div class="form-field">
                <label for="proyecto">Proyecto</label>
                <input type="text" id="proyecto" name="proyecto" placeholder="Proyecto relacionado">
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Informaci√≥n de Cobro -->
          <div class="form-section">
            <h3>Informaci√≥n de Cobro</h3>
            <div class="form-grid">
              <div class="form-field required">
                <label for="medioPago">Medio de Pago</label>
                <select id="medioPago" name="medioPago" required>
                  <option value="">Seleccionar medio...</option>
                  <option value="Efectivo">Efectivo</option>
                  <option value="Transferencia">Transferencia</option>
                  <option value="Tarjeta de Cr√©dito">Tarjeta de Cr√©dito</option>
                  <option value="Tarjeta de D√©bito">Tarjeta de D√©bito</option>
                  <option value="Cheque">Cheque</option>
                  <option value="Mercado Pago">Mercado Pago</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              
              <div class="form-field required">
                <label for="estadoCobro">Estado del Cobro</label>
                <select id="estadoCobro" name="estadoCobro" required>
                  <option value="Cobrado">Cobrado</option>
                  <option value="Pendiente">Pendiente</option>
                  <option value="Cancelado">Cancelado</option>
                </select>
              </div>
              
              <div class="form-field">
                <label for="fechaCobro">Fecha de Cobro</label>
                <input type="date" id="fechaCobro" name="fechaCobro">
              </div>
              
              <div class="checkbox-field">
                <input type="checkbox" id="reflejarEnCaja" name="reflejarEnCaja" checked>
                <label for="reflejarEnCaja">Reflejar en Caja</label>
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Informaci√≥n Adicional -->
          <div class="form-section">
            <h3>Informaci√≥n Adicional</h3>
            <div class="form-grid">
              <div class="form-field" style="grid-column: span 2;">
                <label for="observaciones">Observaciones</label>
                <textarea id="observaciones" name="observaciones" rows="3" placeholder="Informaci√≥n adicional sobre la venta"></textarea>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn" id="btn-guardar">Registrar Venta</button>
            <button type="button" class="btn secondary" id="btn-cancelar" style="display:none;">Cancelar</button>
            <button type="reset" class="btn secondary">Limpiar Formulario</button>
            <div style="flex: 1;"></div>
            <span class="text-muted" style="font-size: 12px;">* Campos obligatorios</span>
          </div>
        </form>
      </div>

      <!-- TABLA DE VENTAS -->
      <div class="card" data-grid="full">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Ventas Registradas</h2>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="buscar-venta" placeholder="Buscar..." 
                   style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); color: var(--text); padding: 6px 10px; border-radius: 6px; min-width: 200px;">
            <select id="filtro-estado" class="btn small">
              <option value="">Todos los estados</option>
              <option value="Cobrado">Cobradas</option>
              <option value="Pendiente">Pendientes</option>
              <option value="Cancelado">Canceladas</option>
            </select>
            <select id="filtro-categoria" class="btn small">
              <option value="">Todas las categor√≠as</option>
              <option value="Productos">Productos</option>
              <option value="Servicios">Servicios</option>
              <option value="Consultor√≠a">Consultor√≠a</option>
              <option value="Desarrollo">Desarrollo</option>
              <option value="Mantenimiento">Mantenimiento</option>
              <option value="Licencias">Licencias</option>
              <option value="Alquileres">Alquileres</option>
              <option value="Honorarios">Honorarios</option>
              <option value="Intereses">Intereses</option>
              <option value="Otros">Otros</option>
            </select>
            <select id="filtro-mes" class="btn small">
              <option value="">Todos los meses</option>
              <!-- Se llenar√° din√°micamente -->
            </select>
          </div>
        </div>

        <div class="tabla-container">
          <table id="tabla-ventas" class="tabla-datos" style="width: 100%;">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Descripci√≥n</th>
                <th>Monto</th>
                <th>Categor√≠a</th>
                <th>Medio Pago</th>
                <th>Estado</th>
                <th>Comprobante</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <!-- Se llenar√° din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>

      <footer class="footer-hg">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="text-muted">√öltima sincronizaci√≥n: <span id="last-sync">nunca</span></div>
          <div class="text-muted">Total ventas: <span id="total-ventas">0</span> | 
            Total ingresos: <span id="total-ingresos">$0</span></div>
        </div>
      </footer>
    </main>
  </div>

  <!-- JS Libraries -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net-buttons@2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net-buttons@2.4.1/js/buttons.html5.min.js"></script>

  <!-- Nuestra aplicaci√≥n -->
  <script src="js/core/config.js"></script>
  <script src="js/core/utils.js"></script>
  <script src="js/core/data-manager.js"></script>
  
  <!-- Script espec√≠fico para esta p√°gina -->
  <!-- ====== REEMPLAZAR DESDE AQU√ç HACIA ABAJO ====== -->
<script>
// ====== SISTEMA DE ACTUALIZACI√ìN EN TIEMPO REAL - CORREGIDO ======
class RealTimeManager {
    constructor() {
        this.pendingUpdates = new Map();
        this.dataCache = new Map();
    }

    addTemporaryRecord(tableId, recordData) {
        const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const tempRecord = {
            ...recordData,
            _tempId: tempId,
            _isPending: true,
            _timestamp: Date.now()
        };

        this.pendingUpdates.set(tempId, {
            tableId,
            record: tempRecord,
            status: 'pending'
        });

        this.updateTableUI(tableId, tempRecord, 'add');
        return tempId;
    }

    updateTableUI(tableId, record, action) {
        const table = document.getElementById(tableId);
        if (!table) {
            console.warn('Tabla no encontrada:', tableId);
            return;
        }

        try {
            if (action === 'add') {
                this.addRowToTable(table, record);
            } else if (action === 'update') {
                this.updateRowInTable(table, record);
            } else if (action === 'remove') {
                this.removeRowFromTable(table, record._tempId);
            }
        } catch (error) {
            console.error('Error actualizando tabla:', error);
        }
    }

    addRowToTable(table, record) {
        // Si hay DataTable, usar su API
        if ($.fn.dataTable.isDataTable(table)) {
            this.addRowWithDataTable(table, record);
        } else {
            this.addRowDirect(table, record);
        }
    }

    addRowWithDataTable(table, record) {
        const dataTable = $(table).DataTable();
        
        // Crear array de datos en el orden correcto
        const rowData = [
            record._tempId || '',
            record.Fecha ? UTILS.formatDate(record.Fecha) : '',
            record['Cliente/Proveedor'] || '',
            record.Descripci√≥n || '',
            UTILS.formatCurrency(record.Monto || 0),
            record.Categor√≠a || '',
            record['Medio de Pago'] || '',
            this.getEstadoHtml(record.Estado),
            record.Comprobante || '',
            this.getAccionesHtml(record, true)
        ];

        // Agregar fila al principio
        const rowNode = dataTable.row.add(rowData).draw(false).node();
        
        // Aplicar estilos
        $(rowNode).attr('data-temp-id', record._tempId);
        $(rowNode).addClass('pending-record fade-in');
        
        // Aplicar data-order para ordenamiento
        if (record.Fecha) {
            $(rowNode).find('td:eq(1)').attr('data-order', new Date(record.Fecha).getTime());
        }
        if (record.Monto) {
            $(rowNode).find('td:eq(4)').attr('data-order', record.Monto);
        }
    }

    addRowDirect(table, record) {
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        
        const row = tbody.insertRow(0);
        row.setAttribute('data-temp-id', record._tempId);
        row.classList.add('pending-record', 'fade-in');

        const headers = ['ID', 'Fecha', 'Cliente', 'Descripci√≥n', 'Monto', 'Categor√≠a', 'Medio Pago', 'Estado', 'Comprobante', 'Acciones'];
        
        headers.forEach((header, index) => {
            const cell = row.insertCell();
            cell.classList.add('pending-cell');
            
            switch(header) {
                case 'ID':
                    cell.textContent = record._tempId || '';
                    break;
                case 'Fecha':
                    cell.textContent = record.Fecha ? UTILS.formatDate(record.Fecha) : '';
                    cell.setAttribute('data-order', new Date(record.Fecha).getTime());
                    break;
                case 'Cliente':
                    cell.textContent = record['Cliente/Proveedor'] || '';
                    cell.style.fontWeight = '600';
                    break;
                case 'Descripci√≥n':
                    cell.textContent = record.Descripci√≥n || '';
                    break;
                case 'Monto':
                    cell.textContent = UTILS.formatCurrency(record.Monto || 0);
                    cell.setAttribute('data-order', record.Monto || 0);
                    break;
                case 'Categor√≠a':
                    cell.textContent = record.Categor√≠a || '';
                    break;
                case 'Medio Pago':
                    cell.textContent = record['Medio de Pago'] || '';
                    break;
                case 'Estado':
                    cell.innerHTML = this.getEstadoHtml(record.Estado);
                    break;
                case 'Comprobante':
                    cell.textContent = record.Comprobante || '';
                    break;
                case 'Acciones':
                    cell.innerHTML = this.getAccionesHtml(record, true);
                    break;
            }
        });
    }

    getEstadoHtml(estado) {
        const estadoClass = estado === 'Cobrado' ? 'status-cobrada' : 
                          estado === 'Pendiente' ? 'status-pendiente' : 'status-cancelada';
        return `<span class="venta-status ${estadoClass}">${estado}</span>`;
    }

    getAccionesHtml(record, isPending = false) {
        if (isPending) {
            return `<div class="action-buttons">
                <button class="btn small" disabled>Editar</button>
                <button class="btn small secondary" disabled>
                    <span class="loader" style="width: 12px; height: 12px;"></span> Guardando...
                </button>
            </div>`;
        } else {
            return `<div class="action-buttons">
                <button class="btn small" onclick="VentasApp.editarVenta('${record.ID}')">Editar</button>
                <button class="btn small secondary" onclick="VentasApp.eliminarVenta('${record.ID}', '${this.escapeString(record.Descripci√≥n)}')">Eliminar</button>
            </div>`;
        }
    }

    updateRowInTable(table, record) {
        const row = table.querySelector(`[data-temp-id="${record._tempId}"]`);
        if (row) {
            row.removeAttribute('data-temp-id');
            row.classList.remove('pending-record');
            
            const cells = row.cells;
            
            // Actualizar ID real
            cells[0].textContent = record.ID || '';
            
            // Actualizar acciones
            if (record._isPending === false) {
                cells[9].innerHTML = this.getAccionesHtml(record, false);
                
                // Remover clases de pending
                Array.from(cells).forEach(cell => {
                    cell.classList.remove('pending-cell');
                    cell.style.fontStyle = 'normal';
                });
            }
            
            // Animaci√≥n de confirmaci√≥n
            row.classList.add('confirmed-record');
            setTimeout(() => row.classList.remove('confirmed-record'), 1500);
        }
    }

    removeRowFromTable(table, tempId) {
        const row = table.querySelector(`[data-temp-id="${tempId}"]`);
        if (row) {
            row.remove();
        }
    }

    confirmRecord(tempId, serverData) {
        const pendingUpdate = this.pendingUpdates.get(tempId);
        if (pendingUpdate) {
            pendingUpdate.status = 'confirmed';
            
            this.updateTableUI(pendingUpdate.tableId, {
                ...serverData,
                _tempId: tempId,
                _isPending: false
            }, 'update');
            
            this.pendingUpdates.delete(tempId);
            this.showToastNotification('‚úÖ Venta confirmada en el servidor', 'success');
        }
    }

    showToastNotification(message, type = 'info') {
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            document.body.appendChild(toastContainer);
        }

        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 4000);
    }

    escapeString(str) {
        return str ? str.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
    }
}

const realTimeManager = new RealTimeManager();

// ====== VENTAS APP CORREGIDA ======
const VentasApp = {
    currentData: null,
    editingVentaId: null,
    dataTable: null,

    async init() {
        console.log('üöÄ Iniciando app de gesti√≥n de ventas...');
        this.setupEventListeners();
        await this.loadData();
    },

    async loadData(forceRefresh = true) {
        try {
            console.log('üì° Cargando datos de ventas...');
            this.mostrarEstado('Cargando datos...', 'loading');

            const data = await DataManager.fetchData(forceRefresh);
            console.log('‚úÖ Datos recibidos:', data);
            
            this.currentData = data;
            this.mostrarEstado('Datos actualizados', 'success');
            this.renderizarTabla(data);
            this.actualizarFiltros(data);
            this.cargarClientes(data);

            const now = new Date();
            document.getElementById('last-sync').textContent = now.toLocaleTimeString();

        } catch(error) {
            console.error('‚ùå Error cargando datos:', error);
            this.mostrarEstado('Error: ' + error.message, 'error');
        }
    },

    mostrarEstado(mensaje, tipo = 'info') {
        const estadoElement = document.getElementById('estado');
        if (!estadoElement) return;

        const iconos = {
            loading: '<span class="loader"></span> ',
            success: '<span style="color: #28a745;">‚úì</span> ',
            error: '<span style="color: #dc3545;">‚úó</span> ',
            info: ''
        };

        estadoElement.innerHTML = (iconos[tipo] || '') + mensaje;
    },

    mostrarLoading(mensaje = 'Procesando informaci√≥n...') {
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        
        if (loadingOverlay && loadingMessage) {
            loadingMessage.textContent = mensaje;
            loadingOverlay.classList.add('active');
        }
    },

    ocultarLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.classList.remove('active');
        }
    },

    cargarClientes(data) {
        const clientes = data.Clientes || [];
        const selectCliente = document.getElementById('cliente');
        
        if (!selectCliente) return;
        
        selectCliente.innerHTML = '<option value="">Seleccionar cliente...</option>';
        const clientesActivos = clientes.filter(c => c.Estado === 'Activo');
        
        clientesActivos.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.Nombre || '';
            option.textContent = cliente.Nombre || '';
            selectCliente.appendChild(option);
        });
        
        console.log(`‚úÖ ${clientesActivos.length} clientes cargados`);
    },

    renderizarTabla(data) {
        const finanzas = data.Finanzas_RegistroDiario || [];
        const ventas = finanzas.filter(item => item.Tipo === 'Ingreso');
        
        const tbody = document.querySelector('#tabla-ventas tbody');
        
        if (!tbody) {
            console.error('‚ùå No se encontr√≥ el tbody de la tabla');
            return;
        }

        tbody.innerHTML = '';

        if (ventas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--muted); padding: 20px;">No hay ventas registradas</td></tr>';
            this.inicializarDataTable([]);
            document.getElementById('total-ventas').textContent = '0';
            document.getElementById('total-ingresos').textContent = '$0';
            return;
        }

        const ventasOrdenadas = [...ventas].sort((a, b) => {
            const fechaA = UTILS.parseDate(a.Fecha || '');
            const fechaB = UTILS.parseDate(b.Fecha || '');
            return fechaB - fechaA;
        });

        let totalIngresos = 0;
        
        ventasOrdenadas.forEach(venta => {
            const fila = document.createElement('tr');
            
            const id = venta.ID || '';
            const fecha = venta.Fecha || '';
            const cliente = venta['Cliente/Proveedor'] || '';
            const descripcion = venta.Descripci√≥n || '';
            const monto = venta.Monto || 0;
            const categoria = venta.Categor√≠a || '';
            const medioPago = venta['Medio de Pago'] || '';
            const estado = venta.Estado || 'Pendiente';
            const comprobante = venta.Comprobante || '';
            
            if (estado === 'Cobrado') {
                totalIngresos += parseFloat(monto) || 0;
            }
            
            const estadoClass = estado === 'Cobrado' ? 'status-cobrada' : 
                             estado === 'Pendiente' ? 'status-pendiente' : 'status-cancelada';

            const fechaOrden = new Date(fecha).getTime();
            
            fila.innerHTML = `
                <td>${id}</td>
                <td data-order="${fechaOrden}">${UTILS.formatDate(fecha)}</td>
                <td style="font-weight: 600;">${cliente}</td>
                <td>${descripcion}</td>
                <td data-order="${monto}">${UTILS.formatCurrency(monto)}</td>
                <td>${categoria}</td>
                <td>${medioPago}</td>
                <td><span class="venta-status ${estadoClass}">${estado}</span></td>
                <td>${comprobante}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn small" onclick="VentasApp.editarVenta('${id}')">Editar</button>
                    <button class="btn small secondary" onclick="VentasApp.eliminarVenta('${id}', '${this.escapeString(descripcion)}')">Eliminar</button>
                  </div>
                </td>
            `;
            tbody.appendChild(fila);
        });

        this.inicializarDataTable(ventasOrdenadas);
        document.getElementById('total-ventas').textContent = ventasOrdenadas.length;
        document.getElementById('total-ingresos').textContent = UTILS.formatCurrency(totalIngresos);
    },

    escapeString(str) {
        return str ? str.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
    },

    inicializarDataTable(ventas) {
        const table = $('#tabla-ventas');
        
        if ($.fn.dataTable.isDataTable(table)) {
            table.DataTable().destroy();
            console.log('üîÑ DataTable anterior destruido');
        }

        if (ventas.length === 0) {
            console.log('üìä Tabla vac√≠a, no se inicializa DataTable');
            return;
        }

        try {
          const dataTable = table.DataTable({
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            order: [[1, 'desc']],
            language: {
              search: "Buscar:",
              lengthMenu: "Mostrar _MENU_ registros",
              info: "Mostrando _START_ a _END_ de _TOTAL_ ventas",
              paginate: {
                first: "Primero",
                last: "√öltimo", 
                next: "Siguiente",
                previous: "Anterior"
              }
            },
            columnDefs: [
              { targets: [1], type: 'num', width: '120px' },
              { targets: [4], type: 'num', width: '120px' },
              { targets: [3], width: '200px' },
              { targets: [7], width: '100px' },
              { targets: [9], width: '140px', orderable: false },
              { targets: '_all', className: 'dt-body-left' }
            ],
            responsive: true,
            stateSave: false
          });

          console.log('‚úÖ DataTable inicializado correctamente');
          this.dataTable = dataTable;
          
        } catch (error) {
          console.error('‚ùå Error inicializando DataTable:', error);
        }
    },

    actualizarFiltros(data) {
        const finanzas = data.Finanzas_RegistroDiario || [];
        const ventas = finanzas.filter(item => item.Tipo === 'Ingreso');
        
        const filtroEstado = document.getElementById('filtro-estado');
        const filtroCategoria = document.getElementById('filtro-categoria');
        const filtroMes = document.getElementById('filtro-mes');
        
        const categorias = [...new Set(ventas.map(v => v.Categor√≠a).filter(Boolean))].sort();
        const meses = [...new Set(ventas.map(v => {
          const fecha = UTILS.parseDate(v.Fecha);
          if (!isNaN(fecha.getTime())) {
            return `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
          }
          return '';
        }).filter(Boolean))].sort().reverse();

        filtroCategoria.innerHTML = '<option value="">Todas las categor√≠as</option>';
        categorias.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          filtroCategoria.appendChild(option);
        });

        filtroMes.innerHTML = '<option value="">Todos los meses</option>';
        meses.forEach(mes => {
          const [year, month] = mes.split('-');
          const monthName = UTILS.getMonthName(parseInt(month), true);
          const option = document.createElement('option');
          option.value = mes;
          option.textContent = `${monthName} ${year}`;
          filtroMes.appendChild(option);
        });

        filtroEstado.addEventListener('change', () => this.aplicarFiltros());
        filtroCategoria.addEventListener('change', () => this.aplicarFiltros());
        filtroMes.addEventListener('change', () => this.aplicarFiltros());
        document.getElementById('buscar-venta').addEventListener('input', () => this.aplicarFiltros());
    },

    aplicarFiltros() {
        const tabla = $('#tabla-ventas').DataTable();
        if (!tabla) return;

        const filtroEstado = document.getElementById('filtro-estado').value;
        const filtroCategoria = document.getElementById('filtro-categoria').value;
        const filtroMes = document.getElementById('filtro-mes').value;
        const busqueda = document.getElementById('buscar-venta').value;

        tabla.column(7).search(filtroEstado);
        tabla.column(5).search(filtroCategoria);
        
        if (filtroMes) {
          tabla.column(1).search(filtroMes, true, false);
        } else {
          tabla.column(1).search('');
        }
        
        tabla.search(busqueda).draw();
    },

    setupEventListeners() {
        const form = document.getElementById('form-venta');
        if (form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                this.guardarVenta();
            });
        }

        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        if (menuToggle && sidebar && overlay) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
            
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        const refreshBtn = document.getElementById('refresh-data');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.mostrarLoading('Actualizando datos...');
                this.loadData(true).finally(() => {
                    this.ocultarLoading();
                });
            });
        }

        const btnCancelar = document.getElementById('btn-cancelar');
        if (btnCancelar) {
            btnCancelar.addEventListener('click', () => {
                this.cancelarEdicion();
            });
        }

        const fechaInput = document.getElementById('fecha');
        if (fechaInput) {
            fechaInput.value = UTILS.getCurrentDateForInput();
        }

        const fechaCobroInput = document.getElementById('fechaCobro');
        if (fechaCobroInput) {
            fechaCobroInput.value = UTILS.getCurrentDateForInput();
        }
    },

    async guardarVenta() {
        const form = document.getElementById('form-venta');
        const formData = new FormData(form);

        const fecha = formData.get('fecha');
        const cliente = formData.get('cliente');
        const descripcion = formData.get('descripcion');
        const monto = formData.get('monto');

        if (!fecha || !cliente || !descripcion || !monto) {
            alert('Por favor complete los campos obligatorios: Fecha, Cliente, Descripci√≥n y Monto.');
            return;
        }

        try {
            // Deshabilitar bot√≥n para evitar doble env√≠o
            const btnGuardar = document.getElementById('btn-guardar');
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<span class="loader"></span> Guardando...';

            const venta = {
                Fecha: fecha,
                'Tipo (Ingreso/Egreso)': 'Ingreso',
                Categor√≠a: formData.get('categoria') || '',
                Subcategor√≠a: formData.get('subcategoria') || '',
                Monto: parseFloat(monto) || 0,
                'Medio de Pago': formData.get('medioPago') || '',
                Comprobante: formData.get('comprobante') || '',
                Descripci√≥n: descripcion,
                Proyecto: formData.get('proyecto') || '',
                'Cliente/Proveedor': cliente,
                Observaciones: formData.get('observaciones') || '',
                'Reflejar en Caja': formData.get('reflejarEnCaja') ? 'S√≠' : 'No',
                Mes: fecha.substring(0, 7),
                Estado: formData.get('estadoCobro') || 'Pendiente',
                'Fecha Pago': formData.get('fechaCobro') || ''
            };

            console.log('üíæ Venta a guardar:', venta);

            // ====== ACTUALIZACI√ìN EN TIEMPO REAL ======
            const tempId = realTimeManager.addTemporaryRecord('tabla-ventas', venta);
            realTimeManager.showToastNotification('Venta agregada temporalmente', 'info');

            let resultado;
            if (this.editingVentaId) {
                resultado = await this.actualizarVenta(this.editingVentaId, venta);
            } else {
                resultado = await this.crearVenta(venta, tempId);
            }

            if (resultado && resultado.record) {
                realTimeManager.confirmRecord(tempId, resultado.record);
            }

            this.mostrarEstado('‚úì Venta registrada exitosamente', 'success');
            
            // Recargar datos para sincronizaci√≥n completa
            await this.loadData(true);
            
            alert('‚úÖ Venta registrada correctamente');
            this.cancelarEdicion();

        } catch (error) {
            console.error('‚ùå Error registrando venta:', error);
            
            let mensajeError = 'Error al registrar la venta. ';
            
            if (error.message.includes('429')) {
                mensajeError += 'Demasiadas solicitudes. Espere unos segundos e intente nuevamente.';
            } else if (error.message.includes('404') || error.message.includes('Failed to fetch')) {
                mensajeError += 'No se pudo conectar con el servidor. Verifica tu conexi√≥n a internet.';
            } else {
                mensajeError += error.message;
            }
            
            realTimeManager.showToastNotification(mensajeError, 'error');
            this.mostrarEstado('‚úó Error al registrar', 'error');
            
            const tempId = error.tempId;
            if (tempId) {
                realTimeManager.updateTableUI('tabla-ventas', { _tempId: tempId }, 'remove');
            }
        } finally {
            // CORRECCI√ìN: Siempre ocultar loading y rehabilitar bot√≥n
            this.ocultarLoading();
            const btnGuardar = document.getElementById('btn-guardar');
            btnGuardar.disabled = false;
            btnGuardar.textContent = this.editingVentaId ? 'Actualizar Venta' : 'Registrar Venta';
        }
    },

    async crearVenta(venta, tempId) {
        try {
            console.log('üì§ CREANDO NUEVA VENTA:', venta);
            
            const datosEnvio = {
                action: 'insert',
                sheet: 'Finanzas_RegistroDiario',
                ...venta
            };

            if (tempId) {
                datosEnvio.tempId = tempId;
            }

            const url = CONFIG.GAS_ENDPOINT + '?' + new URLSearchParams(datosEnvio);
            console.log('üîó URL final:', url);

            const response = await fetch(url);
            const responseText = await response.text();

            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
            }

            const result = JSON.parse(responseText);
            console.log('‚úÖ Resultado parseado:', result);

            if (!result.success) {
                throw new Error(result.error || 'Error desconocido del servidor');
            }

            return result;

        } catch (error) {
            error.tempId = tempId;
            throw error;
        }
    },

    async actualizarVenta(id, venta) {
        try {
            console.log('üì§ ACTUALIZANDO VENTA:', id, venta);
            
            const datosEnvio = {
                action: 'update',
                sheet: 'Finanzas_RegistroDiario',
                id: id,
                ...venta
            };

            const url = CONFIG.GAS_ENDPOINT + '?' + new URLSearchParams(datosEnvio);
            console.log('üîó URL final:', url);

            const response = await fetch(url);
            const responseText = await response.text();

            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
            }

            const result = JSON.parse(responseText);
            console.log('‚úÖ Resultado parseado:', result);

            if (!result.success) {
                throw new Error(result.error || 'Error desconocido del servidor');
            }

            return result;

        } catch (error) {
            console.error('‚ùå ERROR ACTUALIZANDO VENTA:', error);
            throw error;
        }
    },

    async eliminarVenta(id, descripcion) {
        if (!id) {
            alert('‚ùå Error: No se pudo identificar la venta a eliminar');
            return;
        }

        if (!confirm(`¬øEst√° seguro que desea eliminar la venta "${descripcion}"? Esta acci√≥n no se puede deshacer.`)) {
            return;
        }

        try {
            this.mostrarLoading('Eliminando venta...');

            const datosEnvio = {
                action: 'delete',
                sheet: 'Finanzas_RegistroDiario',
                id: id
            };

            console.log('üóëÔ∏è ELIMINANDO VENTA:', id);

            const url = CONFIG.GAS_ENDPOINT + '?' + new URLSearchParams(datosEnvio);
            console.log('üîó URL final:', url);

            const response = await fetch(url);
            const responseText = await response.text();

            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
            }

            const result = JSON.parse(responseText);
            console.log('‚úÖ Resultado parseado:', result);

            if (!result.success) {
                throw new Error(result.error || 'Error desconocido del servidor');
            }

            this.mostrarEstado('‚úì Venta eliminada', 'success');
            await this.loadData(true);
            this.ocultarLoading();
            alert('‚úÖ Venta eliminada correctamente');

        } catch (error) {
            console.error('‚ùå ERROR ELIMINANDO VENTA:', error);
            this.ocultarLoading();
            
            let mensajeError = 'Error al eliminar la venta. ';
            
            if (error.message.includes('429')) {
                mensajeError += 'Demasiadas solicitudes. Espere unos segundos e intente nuevamente.';
            } else if (error.message.includes('404') || error.message.includes('Failed to fetch')) {
                mensajeError += 'No se pudo conectar con el servidor. Verifica tu conexi√≥n a internet.';
            } else {
                mensajeError += error.message;
            }
            
            alert(mensajeError);
            this.mostrarEstado('‚úó Error al eliminar', 'error');
        }
    },

    editarVenta(id) {
        const finanzas = this.currentData?.Finanzas_RegistroDiario || [];
        const venta = finanzas.find(v => v.ID === id && v.Tipo === 'Ingreso');
        
        if (!venta) {
            alert('Venta no encontrada');
            return;
        }

        document.getElementById('fecha').value = venta.Fecha ? UTILS.formatDateForInput(venta.Fecha) : '';
        document.getElementById('cliente').value = venta['Cliente/Proveedor'] || '';
        document.getElementById('descripcion').value = venta.Descripci√≥n || '';
        document.getElementById('comprobante').value = venta.Comprobante || '';
        document.getElementById('monto').value = venta.Monto || '';
        document.getElementById('categoria').value = venta.Categor√≠a || '';
        document.getElementById('subcategoria').value = venta.Subcategor√≠a || '';
        document.getElementById('proyecto').value = venta.Proyecto || '';
        document.getElementById('medioPago').value = venta['Medio de Pago'] || '';
        document.getElementById('estadoCobro').value = venta.Estado || 'Pendiente';
        document.getElementById('fechaCobro').value = venta['Fecha Pago'] ? UTILS.formatDateForInput(venta['Fecha Pago']) : '';
        document.getElementById('reflejarEnCaja').checked = venta['Reflejar en Caja'] === 'S√≠';
        document.getElementById('observaciones').value = venta.Observaciones || '';

        this.editingVentaId = id;
        document.getElementById('form-title').textContent = 'Editando Venta';
        document.getElementById('btn-guardar').textContent = 'Actualizar Venta';
        document.getElementById('btn-cancelar').style.display = 'inline-block';

        document.querySelector('#form-venta').scrollIntoView({ behavior: 'smooth' });
    },

    cancelarEdicion() {
        this.editingVentaId = null;
        document.getElementById('form-title').textContent = 'Nueva Venta';
        document.getElementById('btn-guardar').textContent = 'Registrar Venta';
        document.getElementById('btn-cancelar').style.display = 'none';
        document.getElementById('form-venta').reset();
        
        const fechaInput = document.getElementById('fecha');
        const fechaCobroInput = document.getElementById('fechaCobro');
        if (fechaInput) fechaInput.value = UTILS.getCurrentDateForInput();
        if (fechaCobroInput) fechaCobroInput.value = UTILS.getCurrentDateForInput();
    }
};

// Inicializaci√≥n
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        VentasApp.init();
    });
} else {
    VentasApp.init();
}
</script>
</body>
</html>
[file content end]
